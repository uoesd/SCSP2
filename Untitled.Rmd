---
title: 'Report Title: Example Report'
author: "Group 13  \nDepartment / Course\n"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
    toc: true
    number_sections: true
    toc_depth: 3
csl: ieee.csl
bibliography: references.bib
link-citations: true   
fontsize: 11pt
geometry: margin=1in
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{\textit{Short report title}}
- \fancyhead[R]{\leftmark}
- \fancyfoot[C]{\thepage}
- \usepackage{setspace}
- \onehalfspacing
- \usepackage{titling}
- \pretitle{\begin{center}\LARGE\bfseries}
- \posttitle{\end{center}\vspace{1em}}
- \usepackage{caption}
- \captionsetup[figure]{labelfont=bf,textfont=it}
- \captionsetup[table]{labelfont=bf}
- \usepackage{titlesec}              
- \newcommand{\sectionbreak}{\clearpage}
- |
  \renewcommand{\citeproc}[2]{%
    \hyperref[#1]{\textcolor{blue}{#2}}%
  }
- |
  \let\oldbibitem\bibitem
  \renewcommand{\bibitem}[2][]{%
    \oldbibitem[#1]{#2}%
    \phantomsection\label{#2}%
  } 
---

```{r message=FALSE, warning=FALSE, code=readLines("code.R"), include=FALSE}
# Do not change this code chunk
source("code.R")
```


# Executive Summary

In the UK it is a criminal offence to drive a motor vehicle with a blood or breath alcohol concentration above the prescribed limit. When a person is arrested for driving under the influence of alcohol it is not usually possible to perform an accurate test of the level of alcohol in the blood or breath immediately. Breath tests can be used as an initial screening tool at the scene, but these are not sufficiently accurate for prosecution. Instead, people are taken to a police station or hospital, where the test can be carried out using proper laboratory protocols. As the body clears alcohol from the blood through time this means that if the individual was over the limit, the measured blood alcohol concentration (BAC) will be lower at the time of measurement than it was when the person was driving a motor vehicle. To deal with this situation, If the BAC after time $t$ (hours) is measured as $C_t$ (g/kg), the BAC at time $0$ is estimated as $C_0 = C_t - βt$, where $\beta$ ($g/kg/h$) is BAC elimination rate. 

The key point is how to find a precise $\beta$ to estimate $C_0$. Forensic scientists currently $2.5\%$ percentile of $\beta$ distribution constructing from samples as the estimated $\beta$ value for every individuals. This method is obviously not rigorous enough for the courts, since:

* The courts will be forced to make decisions under estimated $\beta$ if we only give a single estimation of $beta$, since the calculated $C_0$ is either over or under the legal limit.
* Differences between individuals are ignored, for example age and sex, which may affect $\beta$.
* $\beta$ value at $2.5\%$ is over conservative and most uncertainties are hiding.

In this report, we will introduce a Bayesian regression model with considering the heterogeneity between individuals, the model gives a posterior distribution of $\beta$ by using both samples and prior knowledge. Then we randomly simulate $4000$ $\beta$ values from posterior distribution and find out the probability of the person's BAC over limit while driving. 

In real world, $\beta$ estimation is quite difficult, it depends on the individuals' liver condition, drinking habits, genetic, diet, etc. As we don't have corresponding data, in our regression model of $\beta$ is mainly dominate by gender, but we still find some useful variables like 'gender' and 'drinking time'

When it is too late to use a blood or breath test and the only information available is eyewitness testimony of the quantity of alcohol consumed. We have to use Widmark's equation:
$$C_t = \frac{A}{Weight \times V_d} - \beta t$$

where $A$ is Amount of Alcohol Consumed (g), $V_d$ is the volume of distribution that need to be found.

Forensic scientists use the same method again to estimate $V_d$ separately with $\beta$. But $V_d$ and $\beta$ are not independent, so we build a joint Bayesian regression model, which can simulate them together to solve with the correlation. Then again after simulation, each $C_t$ is calculated by each pair of $\beta$ and $V_d$, so expert witness can still find a probability of $C_t$ exceeding the limit.

To make it easier, we write the method in a function so other expert witness can also get the results like Table $5$ by easily plugging new person's data.


# Data Description

It is important to normalized all numerical variables. Centering the covariates can reduce autocorrelation $\rho_k$ of lag $k$ which is defined as:

$$\rho_k = \frac{Cov(\theta^i, \theta^{i+k})}{\theta^2},$$

$\rho_k$ measures how similar the sample at position $i$ is to the sample at position $i+k$. As a random walk process, $\theta_i$ should be similar to $\theta_{i+1}$, less similar to $\theta_{i+2}$, independent with $\theta_{i+k}$ for large $k$. So if $\rho_k$ is large means the chains hardly move, can't converge.

To make it more clear, we will use Effective Sample Size (ESS) to explain: 

$$ n_{\text{eff}} = \frac{n}{1 + 2 \sum_{k=1}^{\infty}\rho_k}.$$ 

'$n_{\text{eff}}$' is large means the MCMC method converge faster (for example if we set $4$ chains with each chains $2000$ iterations, $500$ burn-in, the $n_{\text{eff}} = 4000$ means the number of independent samples is $4000$ out of $8000$). Larger $n_{\text{eff}}$ in same number of iterations means smaller variance of estimated exoectation since:

$$\mathrm{V}(\hat{E}(\beta)) \approx \frac{\sigma^2}{n_{\text{eff}}}.$$

Also Since $\beta$ is a small value, the coefficients of large value variables are pretty small, near 0, which will make $\beta$ estimation worse, so normalization for variables is necessary.
 
Then we prefer to $\beta$ to $\log(\beta)$ since the original $\beta$ distribution has heavy tail, all outliers (if have) can be scaled. As shown in figure 1, $\beta$ forms a good normal distribution shape after log-transferring. After simulation we can take exponential of the results.

```{r echo=FALSE, fig.cap="log(beta) distribution.", message=FALSE, warning=FALSE}
F1
```


Since $\beta$ is a constant rate, measured when the BAC curve reaches peak and starts to decrease, so variables like AAC and Maximum BAC will not be used, since they are correlated with the value of BAC, not BAC elimination rate.

From the dataset, most data comes from age smaller than $30$ ($85/100$), so even though age is sufficient variable for $\beta$ the model can't really recognize it. Research shows that age doesn't really matter unless the subject has age-related liver disease, but because of moral and ethical, we don't find much research of alcohol test on elderly person with liver disease.

'BAC Peak time' is converted to hours.

# Bayesian regression model (BRM)

## Reasons for BRM

Comparing with fitting linear regression model for $\beta_i$, which can be expressed as:

$$\hat{\beta}_{i,j} = \hat{\gamma}_{1}\,\text{female}_j
+ \hat{\gamma}_{2}\,\text{male}_j
+ \hat{\gamma}_{3}\,\text{weight}_j
+ \hat{\gamma}_{4}\,\text{height}_j + \varepsilon_i$$

and giving a exact value of $\hat{\beta_i}$ for $i_{th}$ estimation of $\hat{\beta}$ under $\sigma^2_i$ for $j_{th}$ individuals, BRM can model uncertainty from each coefficient $\hat{\gamma}$. We provide priors and sample likelihoods for each variables' coefficients, BRM will apply bayesian rule to each and output simulation results of each coefficients, not only for $\hat{\beta}$. $\hat{\beta}$s are calculated from simulation results of $\hat{\gamma_j}$, which is:

$$\hat{\beta}_{i,j} = \hat{\gamma}_{1,i}\,\text{female}_j
+ \hat{\gamma}_{2,i}\,\text{male}_j
+ \hat{\gamma}_{3,i}\,\text{weight}_j
+ \hat{\gamma}_{4,i}\,\text{height}_j + \varepsilon_i$$

where

$$
\varepsilon_{\beta,i} \sim \mathcal{N}(0,\, \sigma_\beta^2).
$$

Since we have log-transformed $\beta$ data points, we will take exponential of $\hat{\beta_{i,j}}$ to get actual value.


## How BRM works

We use $brm$ package in R to do this.

The principle theorem behind BRM is Bayes' Rule:

$$p(\theta \mid \text{data}) = \frac{p(\text{data} \mid \theta) \, p(\theta)}{p(\text{data})}.$$

The $\theta$ in the equation is the coefficients of $\gamma_j$. For most real models, we can't compute this posterior $p(\theta \mid \text{data})$ analytically. Markov Chain Monte Carlo (MCMC) helps us draw samples from it, which we can then summarize. BRM uses Hamiltonian Monte Carlo (One of MCMC), which is better than standard MCMC (like Metropolis-Hastings) since it is faster and cost less.

After setting priors for $\gamma_j$, we need specify a family for $\beta$ as the the likelihood of the observed data. In our sample, we have already taken $\log(\beta)$, so it is better to use the most common normal distribution likelihood, it is normal and can express $\beta$ values good without restrict samples' shape.

Also for the MCMC simulation method, we set $4$ chains, each chains $4000$ draws with $1000$ burn-in draws. Since MCMC is a random walk method through parameter space. One chain is a single run of the MCMC algorithm that generates a sequence of samples, so we need more chains to check the convergence and ensure that all chains convergent to same mode. 

For $1000$ burn-in draws, since MCMC starts from an initial value which often far from the true posterior region, so the chains need some steps to walk to the correct trace. As figure 2 shows, it is an example of the MCMC process of 'sexfemale' when using $4$ chains, $100$ draws. Clearly that if we keep the first $25$ draws, the results will be affected. 

```{r echo=FALSE, fig.cap="MCMC Simulations Traceplot.", message=FALSE, warning=FALSE}
F2
```

## Model Selection

### Key Variables

- Female Gender: Female's BAC elimination rate is larger than male on average, it is explained by liver weight represents a greater fraction of lean body mass in the female gender [2].

- Male Gender: The amount of observed male data is acceptable larger than that of female.

- Drinking time after BAC peak: If the person keep drinking after BAC reaches peak, the measured $\beta$ will be smaller since $\beta$ is measured starting at BAC peak time till the end, there will be fluctuations on the BAC plots.

```{r Figure, echo=FALSE, fig.cap="Box plot of beta respect to gender.", message=FALSE, warning=FALSE}

ggplot(data, aes(x = sex, y = beta)) + geom_boxplot() + ggtitle("beta by sex")
```

- Weight: Basically a person's blood alcohol concentration is a function of the total amount of alcohol in the person's system divided by total body water. Larger weight implies higher amount body water

- Height: A measurement of body size other than individual's weight

- Beta60: Improved from the original fixed $\beta$, it demonstrates elimination rate of a person's blood alcohol concentration.



### Priors

Before fitting the Bayesian regression model, appropriate priors need to be specified for all regression coefficients and the residual standard deviation. We use weakly informative priors, which have small effects on the posterior. The selected priors are summarized as follows:

```{r echo=FALSE, message=FALSE, warning=FALSE}
T1
```

All variables have been standardized and we do not expect log(β) to have a linear relationship with the variables, so zero-mean normal priors are appropriate. We consider gender to be one of the main factors influencing alcohol elimination rates @Jones2010, so we set relatively wide priors Normal(0, 2) for the sex coefficients, allowing their effects to vary within a reasonable range. For other standardized variables (such as weight and height), since their impacts on β are considered relatively small, we used more shrinkage weakly informative priors Normal(0, 0.5) to prevent unreasonably large effects. The residual standard deviation is given an Exponential(1) prior, which is a commonly used positive weakly informative prior that can avoid unreasonably high noise.

If future research involves different populations, larger sample sizes, or additional biological information, the prior distributions can be adjusted accordingly to ensure they are applicable to any new datasets.


## Model Results

### Fitting result

After $4000$ iterations in $4$ chains, Table $2$ gives the posterior summary. Rhat compares within-chain variance and between-chain variance, all less than $1.01$ means chains are well‐mixed.

Figure 3 shows posterior results for each variables' coefficients, all coefficients show good normal patterns since we all chains have converged and warm-up length is enough. Since the $\beta$ is log-transformed, the value of 'b_sexfemale' and 'b_sexmale' is not typical value of $\beta$ like $0.19$ when other coefficients are all near zero. Also $\sigma$ value is estimated  under log-transformed $\beta$.

```{r echo=FALSE, fig.cap="Posterioe density of 4 chains for all coefficients.", message=FALSE, warning=FALSE}
F3
```

Figure 4 shows the trace plots for all variable coefficients, it can be seen that all $4$ chains mix well and all values are picking after convergent.

```{r echo=FALSE, fig.cap="Traceplot of all coefficients and variance sigma.", message=FALSE, warning=FALSE}
F4
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
T2
```

### PPC Density
Figure 5 is the Posterior Predictive Check (PPC) density plot comparing with true value of $\beta$ (Here we have taken exponential of both true value and predicted value). Notice that predicted posterior distribution matches $\beta$ sample distribution pretty well, which get the mean, spread, skew both right even at right tail.

```{r echo=FALSE, fig.cap="PPC density of 2000 predict results from posterior.", message=FALSE, warning=FALSE}
F5
```


## Model Testing

We take  $12000$ number of draws from the posterior distribution.

### LOO-PIT QQ plot

The Leave-One-Out Probability Integral Transform Quantile-Quantile plot (LOO-PIT QQ plot) can check if the predictions calibrated correctly and if the predictive distributions biased, which is defined as:
$$ \mathrm{LOO\text{-}PIT}_i = P(\tilde{y}_i \le y_i |y_{-i}) .$$

Here we still use Monte Carlo method to simulate it, as:

$$
\mathrm{LOO\text{-}PIT}_i
= \frac{1}{S} \sum_{s=1}^{S} 
\mathbf{1}\!\left( \tilde{y}_{i,-i}^{(s)} \le y_i \right)
$$

where $S$ is the number of posterior draws. 

We will use it to check if our posterior is under or over dispersion, the good model's PIT plot should be flat over $Uniform(0,1)$. For our model, the PIT histogram (Figure 4) is flat everywhere except probability near 0.55 and 0.8, which are acceptable by the randomness of MCMC method. A U-shape (points over dot line at two tails) in PIT plots means overestimates variance, it doesn't appear in our plot gives evidence of our choices on variables and likelihood family.

```{r echo=FALSE, fig.cap="Probability Integral Transform (PIT) histogram.", message=FALSE, warning=FALSE}
F6
```

### Coverage rate and Errors

Table 3 shows the coverage rate of $95\%$ and $50\%$ predicted intervals, which means $98$ and $52$ individuals' real $\beta$ value is inside the intervals. The MAE and RMSE are both relatively small.


```{r echo=FALSE, message=FALSE, warning=FALSE}
T3
```

### Cross-Validation

We do two kinds of Cross-Validation: LOO and Kfold (table $4$). The two methods show similar results means the model is stable and the $p$ value is near the number of variables ($5$) shows the model is not over-fitting.

```{r echo=FALSE, message=FALSE, warning=FALSE}
T4
```



# Example

Now we will apply our model on an individual example: A $70$ year old female (weight: $70$kg, height: $160$cm) is arrested after being stopped by the police while driving. She provides a blood sample to the police $2$ hours after her arrest which gives a reading of Ct = $0.15$g/kg. The legal limit is x = $0.47$g/kg. 

Since there is no 'drinking time' data here, we will use a simplified model with only 'sex', 'height', 'weight' variables. We have standardized height and weight by using sample's mean and variance. 

As figure 7 shows, this is the posterior density of $C_0$ calculated by presicted posterior density of $\hat{\beta}$ the dot line is the legal limit $C_0 = 0.47$, it can be seen that most density is larger than $0.47$, so obviously the 70 year old female is over the drink driving limit.

```{r echo=FALSE, fig.cap="Posterior Predictive Distribution of C_0, message=FALSE, warning=FALSE, with limit C_0 = 0.47 (dot line).", message=FALSE}
F7
```

To make the result clear, it is better to give Table 5 to the courts and illustrate:

\begin{center}
There is $91.4\%$ probability that the 70 year old female is over the drink driving limit, with both mean, median and mode value over the limit.
\end{center}

The results also show that the original method is not reasonable since $2.5\%$ percentile is over-conservative even in this case.

```{r echo=FALSE, message=FALSE, warning=FALSE}
T5
```

# Widmark's Equation and $V_d$

When it is too late to use a blood or breath test and the only information available is eyewitness testimony of the quantity of alcohol consumed. We have to use Widmark's equation:
$$C_t = \frac{A}{Weight \times V_d} - \beta t.$$
Since there are many versions of Widmark's equation, it can also write as:
$$C_t = \frac{F \times A}{Weight \times \rho} - \beta t $$
where 

$$
\rho = \frac{TBW}{\textit{weight} \times F_{\mathrm{water}}}
$$
is known as Widmark's rho factor.

$F$ is the fraction of the dose that reaches the systemic circulation, $F_{\text{water}}$ is know as the water content of the blood sample, TBW is Total Body Water.

We assume that all different part between two equations are included in $V_d$. The unit of $C_t$ is g/kg in our dataset, the unit of the first term is g/L, but it is not a problem since the density of water is $1$, we just ignore the $1$.

## $V_d$, TBW and $\rho$

All information in this part are from 'Total body water is the preferred method to use in forensic
blood-alcohol calculations rather than ethanol’s volume of distribution'[5].

TBW is calculated by:

$$
\mathrm{TBW}_{\text{Men}}(\mathrm{L}) 
= 2.447 - (0.09516 \times \text{age}) 
    + (0.1074 \times \text{height}) 
    + (0.3362 \times \text{weight})
$$

$$
\mathrm{TBW}_{\text{Women}}(\mathrm{L}) 
= -2.097 
    + (0.1069 \times \text{height}) 
    + (0.2466 \times \text{weight}).
$$


Now subbing the $\rho$ expression in the $C_t$ equation, and comparing with our equation, $V_d$ is actually calculated by:
$$V_d = \frac{\text{TBW}}{\text{weight}} \times \frac{1}{F_{\text{water}}} \times \frac{1}{F} = \eta \times \frac{\text{TBW}}{\text{weight}}$$
and we need to estimate $\eta$ value since TBW is a value that can be determined in our dataset. we will use:

$$\hat{V_d}_{i,j} = \hat{\eta}_{1,i} ( \frac{\text{TBW}}{\text{weight}}_\text{male})_j + \hat{\eta}_{2.i} ( \frac{\text{TBW}}{\text{weight}}_\text{female})_j + \varepsilon_{i}$$
to estimate $\hat{V_d}$ where $i$ is the $i_{th}$ iterations (we will again use BRM, but as a joint model with $\beta$ to deal with the correlation, we will explain it in next part.), $j$ is the $j_{th}$ individuals, $\eta$ is the coefficients that need to be predicted.

## Correlations between $\beta$ and $V_d$

To show that the original method is not good because of the correlation can't be ignored, figure 9 gives the correlations between true $\beta$ and $V_d$ is $-0.415$, which is relatively big.

```{r echo=FALSE, fig.cap="Correlation plot betweem V_d and Beta", message=FALSE, warning=FALSE}
F9
```


## Joint BRM for $\beta$ and $V_d$

$V_d$ is calculated by true value $\beta$ (with our log-transformed). We will not log-transformed $V_d$ since the density of $V_d$ can't be improved by taking log.

```{r echo=FALSE, fig.cap="Density plot of V_d", message=FALSE, warning=FALSE}
F8
```


## Fitting model and Results

The mathematical expression of the joint model can be expressed as:

$$
\hat{\beta}_{i,j} = \hat{\gamma}_{1,i}\,\text{female}_j
+ \hat{\gamma}_{2,i}\,\text{male}_j
+ \hat{\gamma}_{3,i}\,\text{weight}_j
+ \hat{\gamma}_{4,i}\,\text{height}_j + \varepsilon^2_{\beta,i}.
$$
and
$$\hat{V_d}_{i,j} = \hat{\eta}_{1,i} ( \frac{\text{TBW}}{\text{weight}}_\text{male})_j + \hat{\eta}_{2.i} ( \frac{\text{TBW}}{\text{weight}}_\text{female})_j + \varepsilon_{V_d,i}$$

where 
$$
\begin{pmatrix}
\varepsilon_{\beta,i} \\
\varepsilon_{V_d,i}
\end{pmatrix}
\sim
\mathcal{N}\!\left(
\begin{pmatrix} 0 \\ 0 \end{pmatrix},
\begin{pmatrix}
\sigma_\beta^2 
& 
\rho \, \sigma_\beta \sigma_{V_d}
\\[6pt]
\rho \, \sigma_\beta \sigma_{V_d}
& 
\sigma_{V_d}^2 
\end{pmatrix}
\right).
$$

### Model Selection (priors)

The prior for $\beta$'s variables' coefficients is unchanged. And the prior for $\eta$ is easy to calculated since $\eta = \frac{1}{F_{\text{water}}} \times \frac{1}{F}$.

The Blood water content $F_{\text{water}}$ is easy to determine by desiccation and the mean reported values for men and women are $0.825\%$ w/v and $0.838\%$ w/v respectively. The small sex difference is mainly attributed to lower haematocrit in female blood samples[].

The fraction of the alcohol dose that reaches the systemic circulation $F$ is typically $0.7$−$0.9$. So:

* Prior for $\frac{\text{TBW}}{\text{weight}}_\text{male}$ is $Normal(\frac{1}{0.825} \times \frac{1}{0.8}, 2)  = Normal(1.51, 2)$
* Prior for $\frac{\text{TBW}}{\text{weight}}_\text{male}$ is $Normal(\frac{1}{0.848} \times \frac{1}{0.8}, 2)  = Normal(1.49, 2)$

The mean value of two priors is actually near to the linear regression results of single $V_d$ model ($1.41$ for male and $1.3$ for female).

Priors for others are still weak informative priors. Settings for others are not changed ($4$ chains, $4000$ iterations, $1000$ warm-up).

### Results

Table $6$ belew is the results table, all Rhat and ESS are in good range. The expected estimated correlation $-0.46$ in the model is also near the sample's $V_d$-$\beta$ correlation $-0.415$ (the log-transformation of $\beta$ doesn't affect the correlation.)

```{r echo=FALSE, message=FALSE, warning=FALSE}
T6
```

```{r echo=FALSE, fig.cap="Joint posterior distribution", message=FALSE, warning=FALSE}  
F10
```

## Testing 

Table $7$ is the LOO and Kfold results, the p values ($11.0479$ and $10.691$) means the validation results are good since we have $10$ parameters.

```{r echo=FALSE, message=FALSE, warning=FALSE}
T7
```


Table $8$ shows the MSE of $\beta$, $V_d$ and calculated $C_0$ from joint posterior distribution comparing with true value, and also a MSE for single $\beta$ model to test if the results worse when take in $V_d$. The estimation result for $\beta$ is better than before (because of the correlation, $V_d$ explain some variation of $\beta$).

```{r echo=FALSE, message=FALSE, warning=FALSE}
T8
```


# Reference

















# Variable Description 
- how many observations do we have?
where we get the resourse, reference?
explain each variables in table

The variables identified for the analysis are demographic and physiological characteristics from the tested individuals after drinking alcohol. Our variable selection is informed by their established relevance to human liver metabolic function, especially sex, age, weight and height are included due to the significant influence on liver metabolism.


* Sex: Biological sex of the individual, male or female
* Age: 
* Weight  
* Height
* Beta60:
* Co:

Page, Participant number, FigureOnPage, Sample Type... clearly inrevelant,

Maximum BAC/BrAC,BAC peak time 也可推断为无关factor 与police预测受测者驾驶中酒精浓度的目标不同

#Limitation
our model limit
data collected reason - cannot reflect the real world
model reason
other reason: variables






#Reference
#测两次血预测beta
#如果司机坐在方向盘后面没有被捕，瑞典的交警通常会提交间隔约1小时采集的双重血液样本。假设存在吸收后下降阶段和零阶动力学操作，#每个采样时间的平均结果可用于计算酒精的消除率。根据长期调查酒后驾车案件的经验，第一个血液样本通常在逮捕后60分钟获得，这取决##于该人被逮捕的全国地点以及是否有医生或护士抽血。
#https://www.sciencedirect.com/science/article/pii/S0379073810000770?via%3Dihub

P.Y. Kwo, V.A. Ramchandani, S. O’Connor, D. Amann, L.G. Carr, K. Sandrasegaran, K.K. Kopecky, T.K. Li
Gender differences in alcohol metabolism: relationship to liver volume and effect of adjusting for body mass
Gastroenterology, 115 (1998), pp. 1552-1557